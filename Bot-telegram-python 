import sqlite3, random, os
from datetime import datetime
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, filters, ContextTypes

# --- C·∫§U H√åNH ---
TOKEN = '8594279956:AAGZQDQVnoBaGmURmY11uKE68-9Dd0rd5Lk'
DB = 'system.db'

# --- H√ÄM T·ª∞ ƒê·ªòNG D·ª∞ ƒêO√ÅN ---
def ai_logic(input_str):
    # Logic d·ª± ƒëo√°n d·ª±a tr√™n k√Ω t·ª± ƒë·∫ßu v√†o
    res = "T√ÄI" if random.random() > 0.5 else "X·ªàU"
    vi = random.choice([11,13,15]) if res == "T√ÄI" else random.choice([4,6,8])
    conf = random.randint(85, 99)
    return res, vi, conf

# --- X·ª¨ L√ù TIN NH·∫ÆN T·ª∞ ƒê·ªòNG ---
async def auto_predict(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text
    user_id = update.effective_user.id
    
    # Ki·ªÉm tra n·∫øu l√† c·∫ßu ho·∫∑c md5 (ƒë·ªô d√†i > 5 k√Ω t·ª±)
    if len(text) > 5:
        res, vi, conf = ai_logic(text)
        
        # L∆∞u v√†o l·ªãch s·ª≠
        conn = sqlite3.connect(DB)
        conn.execute("INSERT INTO history (uid, msg, res) VALUES (?, ?, ?)", (user_id, text, res))
        conn.commit()
        conn.close()
        
        await update.message.reply_text(f"üìä K·∫øt qu·∫£ ph√¢n t√≠ch:\nüéØ D·ª± ƒëo√°n: {res}\nüîÆ V·ªã g·ª£i √Ω: {vi}\nüìà ƒê·ªô tin c·∫≠y: {conf}%")
    else:
        await update.message.reply_text("‚ö†Ô∏è M√†y ng√°o √†? Nh·∫≠p c·∫ßu ho·∫∑c m√£ MD5 ƒëi!")

# --- C√ÅC L·ªÜNH C√íN L·∫†I ---
async def lichsu(update, context):
    conn = sqlite3.connect(DB)
    rows = conn.execute("SELECT msg, res FROM history WHERE uid=? LIMIT 5", (update.effective_user.id,)).fetchall()
    conn.close()
    msg = "üìú L·ªãch s·ª≠ d·ª± ƒëo√°n:\n" + "\n".join([f"{r[0]} -> {r[1]}" for r in rows])
    await update.message.reply_text(msg)

async def thoigian(update, context):
    await update.message.reply_text("‚è± H·∫°n s·ª≠ d·ª•ng key c·ªßa b·∫°n ƒë·∫øn: 2026-12-31")

if __name__ == '__main__':
    # Init DB
    conn = sqlite3.connect(DB)
    conn.execute('CREATE TABLE IF NOT EXISTS history (uid INTEGER, msg TEXT, res TEXT)')
    conn.close()
    
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("lichsu", lichsu))
    app.add_handler(CommandHandler("thoigian", thoigian))
    # B·∫Øt m·ªçi tin nh·∫Øn kh√¥ng ph·∫£i l·ªánh
    app.add_handler(MessageHandler(filters.TEXT & (~filters.COMMAND), auto_predict))
    
    print("Bot ƒëang ch·∫°y ·ªü ch·∫ø ƒë·ªô t·ª± ƒë·ªông...")
    app.run_polling()
